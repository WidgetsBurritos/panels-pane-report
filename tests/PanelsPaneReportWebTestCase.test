<?php

/**
 * @file
 * Panels Pane Report Web Tests.
 */

/**
 * Web tests for the Panels Pane Report.
 *
 * @ingroup Panels Pane Report
 */
class PanelsPaneReportWebTestCase extends DrupalWebTestCase {
  protected $profile = 'testing';

  /**
   * Implements getInfo().
   */
  public static function getInfo() {
    return array(
      'name' => t('Panels Panel Report Web Tests'),
      'description' => t('Test panels pane report functionality'),
      'group' => t('Panels Pane Report'),
    );
  }

  /**
   * Implements setUp().
   */
  public function setUp() {
    parent::setUp(array(
      'panels_pane_report',
      'panels_node',
      'page_manager',
      'panels_mini',
      'panelizer',
    ));
    db_truncate('panels_pane_report');
  }

  /**
   * Test report is accessible with permission.
   */
  public function testReportIsAccessible() {
    $admin_user = $this->drupalCreateUser(array(
      'access panels pane report',
    ));

    $this->drupalLogin($admin_user);
    $this->drupalGet('admin/reports/panels-pane-report');
    $this->assertText(t('Panels Pane Report'), 'Access allowed on panels pane report.');
  }

  /**
   * Test report is inaccessible without permission.
   */
  public function testReportIsInaccessible() {
    $admin_user = $this->drupalCreateUser(array());

    $this->drupalLogin($admin_user);
    $this->drupalGet('admin/reports/panels-pane-report');
    $this->assertText(t('Access denied'), 'Access denied on panels pane report.');
  }

  /**
   * Test report is accessible with permission.
   */
  public function testReportSettingsAreAccessible() {
    $admin_user = $this->drupalCreateUser(array(
      'administer panels pane report settings',
    ));

    $this->drupalLogin($admin_user);
    $this->drupalGet('admin/config/system/panels_pane_report');
    $this->assertText(t('Panels Pane Report'), 'Access allowed on panels pane report.');
  }

  /**
   * Test report is inaccessible without permission.
   */
  public function testReportSettingsAreInaccessible() {
    $admin_user = $this->drupalCreateUser(array());

    $this->drupalLogin($admin_user);
    $this->drupalGet('admin/config/system/panels_pane_report');
    $this->assertText(t('Access denied'), 'Access denied on panels pane report.');
  }

  /**
   * Test report can be regenerated with permission.
   */
  public function testReportCanBeRegenerated() {
    $admin_user = $this->drupalCreateUser(array(
      'access panels pane report',
      'generate panels pane report',
    ));

    $this->drupalLogin($admin_user);
    $this->drupalGet('admin/reports/panels-pane-report');
    $this->assertField('edit-regenerate-report');
  }

  /**
   * Test report can't be regenerated without permission.
   */
  public function testReportCantBeRegenerated() {
    $admin_user = $this->drupalCreateUser(array(
      'access panels pane report',
    ));

    $this->drupalLogin($admin_user);
    $this->drupalGet('admin/reports/panels-pane-report');
    $this->assertNoField('edit-regenerate-report');
  }

  /**
   * Test filter contains expected filter options.
   */
  public function testExpectedFilterOptions() {
    $row = array(
      'entity_type' => 'puppy',
      'pattern_storage_id' => 'k9',
      'page_storage_id' => 'yard1',
      'display_storage_type' => 'doghouse',
      'display_storage_id' => 'woofhouse9',
      'display_layout' => 'single',
      'build_mode' => 'retriever',
      'style_mode' => 'golden',
      'bundle' => 'litter',
    );
    PanelsPaneReport::reportItem($row);

    $admin_user = $this->drupalCreateUser(array(
      'access panels pane report',
    ));

    $this->drupalLogin($admin_user);

    $this->drupalGet('admin/reports/panels-pane-report');

    // Entity Types.
    $this->assertRaw('<option value="puppy">puppy</option>');

    // Bundles.
    $this->assertRaw('<option value="litter">litter</option>');

    // Build Modes.
    $this->assertRaw('<option value="retriever">retriever</option>');

    // Style Modes.
    $this->assertRaw('<option value="golden">golden</option>');

    // Containers.
    $this->assertRaw('<option value="doghouse">doghouse</option>');

    // Container Layout.
    $this->assertRaw('<option value="single">single</option>');
  }

  /**
   * Tests null page and pattern statuses.
   */
  public function testNullPageAndPatternStatus() {
    $row = array(
      'entity_type' => 'puppy',
      'pattern_storage_id' => 'k9',
      'pattern_status' => NULL,
      'page_storage_id' => 'yard1',
      'page_status' => NULL,
      'display_storage_type' => 'doghouse',
      'display_storage_id' => 'woofhouse9',
      'build_mode' => 'retriever',
      'style_mode' => 'golden',
      'bundle' => 'litter',
    );
    PanelsPaneReport::reportItem($row);

    $admin_user = $this->drupalCreateUser(array(
      'access panels pane report',
    ));

    $this->drupalLogin($admin_user);
    $this->drupalGet('admin/reports/panels-pane-report');
    $this->assertRaw('<span class="page-status"></span>');
    $this->assertRaw('<span class="pattern-status"></span>');
    $this->assertNoRaw('<span class="page-status">✔</span>');
    $this->assertNoRaw('<span class="pattern-status">✔</span>');
    $this->assertNoRaw('<span class="page-status">✖</span>');
    $this->assertNoRaw('<span class="pattern-status">✖</span>');
  }

  /**
   * Tests true page and pattern statuses.
   */
  public function testTruePageAndPatternStatus() {
    $row = array(
      'entity_type' => 'puppy',
      'pattern_storage_id' => 'k9',
      'pattern_status' => 1,
      'page_storage_id' => 'yard1',
      'page_status' => 1,
      'display_storage_type' => 'doghouse',
      'display_storage_id' => 'woofhouse9',
      'build_mode' => 'retriever',
      'style_mode' => 'golden',
      'bundle' => 'litter',
    );
    PanelsPaneReport::reportItem($row);

    $admin_user = $this->drupalCreateUser(array(
      'access panels pane report',
    ));

    $this->drupalLogin($admin_user);
    $this->drupalGet('admin/reports/panels-pane-report');
    $this->assertRaw('<span class="page-status">✔</span>');
    $this->assertRaw('<span class="pattern-status">✔</span>');
    $this->assertNoRaw('<span class="page-status"></span>');
    $this->assertNoRaw('<span class="pattern-status"></span>');
    $this->assertNoRaw('<span class="page-status">✖</span>');
    $this->assertNoRaw('<span class="pattern-status">✖</span>');
  }

  /**
   * Tests false page and pattern statuses.
   */
  public function testFalsyPageAndPatternStatus() {
    $row = array(
      'entity_type' => 'puppy',
      'pattern_storage_id' => 'k9',
      'pattern_status' => 0,
      'page_storage_id' => 'yard1',
      'page_status' => 0,
      'display_storage_type' => 'doghouse',
      'display_storage_id' => 'woofhouse9',
      'build_mode' => 'retriever',
      'style_mode' => 'golden',
      'bundle' => 'litter',
    );
    PanelsPaneReport::reportItem($row);

    $admin_user = $this->drupalCreateUser(array(
      'access panels pane report',
    ));

    $this->drupalLogin($admin_user);
    $this->drupalGet('admin/reports/panels-pane-report');
    $this->assertRaw('<span class="page-status">✖</span>');
    $this->assertRaw('<span class="pattern-status">✖</span>');
    $this->assertNoRaw('<span class="page-status"></span>');
    $this->assertNoRaw('<span class="pattern-status"></span>');
    $this->assertNoRaw('<span class="page-status">✔</span>');
    $this->assertNoRaw('<span class="pattern-status">✔</span>');
  }

  /**
   * Test report supports panels node containers.
   */
  public function testPanelsNodeContainers() {
    $admin_user = $this->drupalCreateUser(array(
      'access panels pane report',
      'generate panels pane report',
    ));

    // Create temporary nodes.
    $pane_node = $this->drupalCreateNode(array('type' => 'widget', 'uid' => $admin_user->uid));
    $panels_node = $this->drupalCreateNode(array('type' => 'panels_node'));

    $config_array = array('nid' => $pane_node->nid, 'build_mode' => 'burrito');

    // Create display.
    $display = self::createNewPanelsDisplay('panels_node', $panels_node->nid);

    // Create the panes.
    $pane = self::createNewPanelsPane($config_array, 'node', 'node');

    // Add pane to display.
    self::addPaneToDisplay($display, $pane);

    // Attempt to login and regenerate the report.
    $this->drupalLogin($admin_user);
    $submit_options = array('query' => array('op' => 'Regenerate Report'));
    $this->drupalGet('admin/reports/panels-pane-report', $submit_options);
    $this->assertText('node:widget');
    $this->assertText('Build Mode: burrito');
    $this->assertText('Style: wrapped');
    $this->assertText($pane_node->title);
    $this->assertText($panels_node->title);
    $this->assertRaw('<a href="' . url('node/' . $pane_node->nid) . '" target="_blank">node/' . $pane_node->nid . '</a>');
    $this->assertRaw('<a href="' . url('node/' . $panels_node->nid) . '" target="_blank">node/' . $panels_node->nid . '</a>');
    $this->assertText('panels_node [' . $panels_node->nid . ']');
    $this->assertText('Layout: twocol');
  }

  /**
   * Creates a Panels pane.
   */
  private function createNewPanelsPane(array $configuration = array(), $type = 'node', $subtype = 'node') {
    $pane = panels_new_pane($type, $subtype, TRUE);
    $pane->panel = 'left';
    $pane->configuration = $configuration;
    $pane->style = array('style' => 'wrapped', 'settings' => array());

    return $pane;
  }

  /**
   * Creates a Panels display object.
   */
  private function createNewPanelsDisplay($storage_type, $storage_id) {
    $display = panels_new_display();
    $display->layout = 'twocol';
    $display->storage_type = $storage_type;
    $display->storage_id = $storage_id;

    return $display;
  }

  /**
   * Creates a new Mini Panel object.
   */
  private function createNewMiniPanel($name = 'grid_1', $title = NULL) {
    // Create a new mini panel.
    $mini_panel = panels_mini_new();
    $mini_panel->category = '';
    $mini_panel->display = self::createNewPanelsDisplay('panels_mini', $name);
    $mini_panel->name = $name;
    $mini_panel->admin_title = isset($title) ? $title : $name;
    $mini_panel->admin_description = '';

    return $mini_panel;
  }

  /**
   * Adds a pane to the specified display.
   */
  private function addPaneToDisplay(&$display, $pane) {
    $display->panels[$pane->panel][] = $pane->pid;
    $display->panel_settings['style_settings'][$pane->panel] = NULL;
    $display->content[$pane->pid] = $pane;
    panels_save_display($display);
  }

  /**
   * Test report supports panels_mini containers.
   */
  public function testPanelsMiniContainers() {
    $admin_user = $this->drupalCreateUser(array(
      'access panels pane report',
      'generate panels pane report',
    ));

    // Create temporary nodes.
    $node1 = $this->drupalCreateNode(array('type' => 'widget', 'uid' => $admin_user->uid));
    $node2 = $this->drupalCreateNode(array('type' => 'burrito', 'uid' => $admin_user->uid));

    // Create a mini panel.
    $mp_name = 'grid_1';
    $mp = self::createNewMiniPanel($mp_name);

    // Create the panes.
    $pane1 = self::createNewPanelsPane(array(
      'nid' => $node1->nid,
      'build_mode' => 'extended',
    ));

    $pane2 = self::createNewPanelsPane(array(
      'nid' => $node2->nid,
      'build_mode' => 'limited',
    ));

    // Add the panes to the display.
    self::addPaneToDisplay($mp->display, $pane1);
    self::addPaneToDisplay($mp->display, $pane2);

    panels_mini_save($mp);

    // Attempt to login and regenerate the report.
    $this->drupalLogin($admin_user);
    $submit_options = array('query' => array('op' => 'Regenerate Report'));
    $this->drupalGet('admin/reports/panels-pane-report', $submit_options);
    $this->assertText('node:widget');
    $this->assertText('node:burrito');
    $this->assertText('Style: wrapped');
    $this->assertText($node1->title);
    $this->assertText($node2->title);
    $this->assertRaw('<a href="' . url('node/' . $node1->nid) . '" target="_blank">node/' . $node1->nid . '</a>');
    $this->assertRaw('<a href="' . url('node/' . $node2->nid) . '" target="_blank">node/' . $node2->nid . '</a>');
    $this->assertText('panels_mini [' . $mp_name . ']');
    $this->assertText('Layout: twocol');
  }

  /**
   * Test report supports panels_mini entity.
   */
  public function testPanelsMiniEntity() {
    // Create admin user.
    $admin_user = $this->drupalCreateUser(array(
      'access panels pane report',
      'generate panels pane report',
    ));

    // Create temporary node.
    $node = $this->drupalCreateNode(array(
      'type' => 'panels_node',
      'uid' => $admin_user->uid,
      'panels_node' => array(
        'layout' => 'twocol',
      ),
    ));

    // Create display.
    $display = self::createNewPanelsDisplay('panels_node', $node->nid);

    // Create a mini panel.
    $mp = self::createNewMiniPanel();
    panels_mini_save($mp);

    // Create the panes.
    $pane = self::createNewPanelsPane(array(
      'build_mode' => 'burrito',
    ), 'panels_mini', $mp->name);

    // Add pane to display.
    self::addPaneToDisplay($display, $pane);

    // Attempt to login and regenerate the report.
    $this->drupalLogin($admin_user);
    $submit_options = array('query' => array('op' => 'Regenerate Report'));
    $this->drupalGet('admin/reports/panels-pane-report', $submit_options);
    $this->assertText('panels_mini');
    $this->assertText('Build Mode: burrito');
    $this->assertText('Style: wrapped');
    $this->assertText($node->title);
    $this->assertRaw('<a href="' . url('admin/structure/mini-panels/list/' . $mp->name) . '" target="_blank">' . $mp->name . '</a>');
    $this->assertRaw('<a href="' . url('node/' . $node->nid) . '" target="_blank">node/' . $node->nid . '</a>');
    $this->assertText('panels_node [' . $node->nid . ']');
    $this->assertText('Layout: twocol');
  }

  /**
   * Test report supports panelizer_entity containers.
   */
  public function testPanelizerEntityContainers() {
    // Attempt to login.
    $admin_user = $this->drupalCreateUser(array(
      'access panels pane report',
      'generate panels pane report',
      'administer content types',
      'bypass node access',
      'administer panelizer',
    ));
    $this->drupalLogin($admin_user);

    // Create a content type and panelize it.
    $content_type = $this->drupalCreateContentType();
    $edit = array(
      'panelizer[status]' => TRUE,
      'panelizer[view modes][default][status]' => TRUE,
    );
    $this->drupalPost('admin/structure/types/manage/' . $content_type->name, $edit, t('Save content type'));

    // Create and panelize our node.
    $panelizer_node = $this->drupalCreateNode(array('type' => $content_type->name, 'uid' => $admin_user->uid));
    $this->drupalPost('node/' . $panelizer_node->nid . '/panelizer/default', array(), t('Panelize it!'));
    $storage_id = 'node:' . $panelizer_node->nid . ':default';

    // Create a display for our node.
    $display = self::createNewPanelsDisplay('panelizer_entity', $storage_id);

    // Create temporary content node and add it to the panelizer container.
    $pane_node = $this->drupalCreateNode(array('type' => 'widget', 'uid' => $admin_user->uid));
    $config_array = array('nid' => $pane_node->nid, 'build_mode' => 'burrito');
    $pane = self::createNewPanelsPane($config_array);
    self::addPaneToDisplay($display, $pane);

    // Attempt to regenerate the report.
    $submit_options = array('query' => array('op' => 'Regenerate Report'));
    $this->drupalGet('admin/reports/panels-pane-report', $submit_options);
    $this->assertText('entity_field');
    $this->assertText('node_links');
    $this->assertText('node:widget');
    $this->assertText('Build Mode: burrito');
    $this->assertText('Build Mode: default');
    $this->assertText('Style: wrapped');
    $this->assertRaw('<a href="' . url('node/' . $pane_node->nid) . '" target="_blank">node/' . $pane_node->nid . '</a>');
    $this->assertRaw('<a href="' . url('node/' . $panelizer_node->nid) . '" target="_blank">node/' . $panelizer_node->nid . '</a>');
    $this->assertText('panelizer_entity [' . $storage_id . ']');
    $this->assertText('Layout: twocol');
  }

}
